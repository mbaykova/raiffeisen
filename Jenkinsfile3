#!groovy
import groovy.json.JsonParserType
import groovy.json.JsonSlurper
node('master') {

    stage('Checkout') {
        checkout scm
    }

    def jiraHost = "http://localhost:8087"
    def testRunKey = "TEST-C1"
    def username = "admin"
    def password = "admin"
    def baseURL = "${jiraHost}/rest/atm/1.0/testrun/${testRunKey}";
    def authString = "${username}:${password}".bytes.encodeBase64().toString();

    def url = new URL(baseURL);

    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
    connection.setRequestMethod("GET");
    connection.doOutput = true
    connection.addRequestProperty("Authorization", "Basic ${authString}")
    connection.getResponseCode()
    def response = connection.getInputStream().getText()
    def jsonSlurper= new groovy.json.JsonSlurper(type: JsonParserType.INDEX_OVERLAY)
    def object = jsonSlurper.parseText(response);
    assert object instanceof Map
    String[] tags = object.items.testCaseKey
    tags.collect{"@$it"}.join(',')
    echo tags




}